<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${i18n.welcomeTitle}</title>
    <style>
        body {
            background-color: #0C0C0C;
            color: #CCCCCC;
            font-family: 'Consolas','Monaco',monospace;
            margin:0;padding:20px;line-height:1.5;
        }
        #terminal {
            height:80vh;
            overflow-y:auto;
            white-space:pre-wrap;
            margin-bottom:10px;
            user-select:text;
        }
        .command-line {
            display:flex;
            align-items:center;
            margin-bottom:5px;
        }
        .prompt {
            color:#4CAF50;
            margin-right:8px;
            white-space:nowrap;
        }
        .input-container {
            display:flex;
            flex-grow:1;
            align-items:center;
            white-space:pre;
            position: relative;
        }
        .cursor {
            background-color:white;
            color:black;
        }
        .cursor-blink {
            animation: blink 0.8s step-start infinite;
        }
        @keyframes blink {
            0%,50%,100% { opacity:1; }
            25%,75% { opacity:0; }
        }
        .default-text {color:#0f0;}
        .log-error {color:#F44336;}
        .log-warn {color:#FFC107;}
        .log-info {color:#4FC3F7;}
        .log-success {color:#4CAF50;}
        .log-system {color:#9C27B0;}
        .log-debug {color:#9E9E9E;}
        .timestamp {color:#607D8B;margin-right:8px;font-size:0.9em;}
        .terminal-border {border:1px solid #333;padding:10px;border-radius:4px;}
        #hidden-input {position:absolute;left:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;}
    </style>
</head>
<body>
<div class="terminal-border">
    <div id="terminal" class="default-text"></div>
    <div id="current-line" class="command-line">
        <span class="prompt">$</span>
        <div class="input-container"><span id="command-display"></span></div>
    </div>
</div>
<input type="text" id="hidden-input">

<script>
    const terminal = document.getElementById('terminal');
    const currentLine = document.getElementById('current-line');
    const commandDisplay = document.getElementById('command-display');
    const hiddenInput = document.getElementById('hidden-input');

    let commandBuffer = '';
    let cursorPos = 0;
    let commandHistory = [];
    let historyIndex = -1;

    let socket = null;
    let userId = 'arguslog';

    function getContextPath() {
        const fullPath = window.location.pathname;
        const terminalIndex = fullPath.indexOf('/arguslog/index.html');
        return terminalIndex > 0 ? fullPath.substring(0, terminalIndex) : '';
    }

    function getWebSocketUrl() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const contextPath = getContextPath();
        return `${protocol}//${host}${contextPath}/arguslog-ws`;
    }

    window.APP_CONFIG = { socketUrl: getWebSocketUrl(), contextPath: getContextPath() };

    function parseMessageType(message) {
        if (typeof message !== 'string') return { type: 'info', content: message };
        const patterns = [
            { prefix: '[ERROR]', type: 'error' },
            { prefix: '[WARN]', type: 'warn' },
            { prefix: '[INFO]', type: 'info' },
            { prefix: '[SUCCESS]', type: 'success' },
            { prefix: '[SYSTEM]', type: 'system' },
            { prefix: '[DEBUG]', type: 'debug' }
        ];
        for (const p of patterns) {
            if (message.startsWith(p.prefix)) return { type: p.type, content: message.slice(p.prefix.length).trim() };
        }
        return { type:'info', content:message };
    }

    function appendToTerminal(text, type='info', time=true) {
        let displayText = text, displayType = type;
        if(typeof text==='object'){ displayText=text.content; displayType=text.type; }
        const line=document.createElement('div');
        if(time){ const ts=document.createElement('span'); ts.className='timestamp'; ts.textContent=new Date().toLocaleTimeString(); line.appendChild(ts);}
        const content=document.createElement('span'); content.className=`log-${displayType}`; content.textContent=displayText;
        line.appendChild(content);
        terminal.appendChild(line);
        terminal.scrollTop=terminal.scrollHeight;
    }

    function clearTerminal(){
        terminal.innerHTML='';
        appendToTerminal('${i18n.terminalCleared}','system');
    }

    function updatePrompt(connected=false){
        const prompt = currentLine.querySelector('.prompt');
        prompt.textContent = connected ? `${userId}>` : '$';
    }

    // ---------- WebSocket ----------
    function connectSocket(){
        if(socket && socket.readyState===WebSocket.OPEN){ appendToTerminal('${i18n.alreadyConnected}','warn'); return; }
        if(!window.APP_CONFIG?.socketUrl){ appendToTerminal('Error: WebSocket URL not configured','error'); return; }
        appendToTerminal(`Connecting to ${window.APP_CONFIG.socketUrl}...`,'info');
        try{
            socket=new WebSocket(window.APP_CONFIG.socketUrl);
            socket.onopen=()=>{ appendToTerminal('${i18n.connected}','success'); updatePrompt(true); };
            socket.onerror=(e)=>{ appendToTerminal('WebSocket error: '+(e.message||'Unknown error'),'error'); };
            socket.onclose=(e)=>{ appendToTerminal(`Disconnected (code ${e.code})`,'system'); updatePrompt(false); };
            socket.onmessage=(e)=>{ appendToTerminal(parseMessageType(e.data)); };
        }catch(err){ appendToTerminal('Connection failed: '+err.message,'error'); }
    }

    function disconnectSocket(){
        if(socket && socket.readyState===WebSocket.OPEN){ socket.close(); appendToTerminal('${i18n.connectionClosed}','system'); }
        else appendToTerminal('${i18n.notConnected}','warn');
    }

    // ---------- 历史 ----------
    function addToHistory(cmd){
        if(cmd && (commandHistory.length===0 || commandHistory[commandHistory.length-1]!==cmd)){
            commandHistory.push(cmd); if(commandHistory.length>50) commandHistory.shift();
        }
        historyIndex = commandHistory.length;
    }

    // ---------- 光标渲染 ----------
    function renderCommand(){
        let before = commandBuffer.slice(0,cursorPos);
        let under = commandBuffer[cursorPos]||' ';
        let after = commandBuffer.slice(cursorPos+1);
        // 只有行尾闪烁
        const isEnd = (cursorPos === commandBuffer.length);
        commandDisplay.innerHTML = before + '<span class="cursor'+(isEnd?' cursor-blink':'')+'">'+under+'</span>' + after;
    }

    // ---------- 执行命令 ----------
    function executeCommand(cmd){
        if(!cmd) return;
        const line=document.createElement('div'); line.className='command-line';
        const prompt = document.createElement('span'); prompt.className='prompt'; prompt.textContent=currentLine.querySelector('.prompt').textContent;
        const span=document.createElement('span'); span.className='input-container'; span.textContent=cmd;
        line.appendChild(prompt); line.appendChild(span);
        terminal.appendChild(line);
        terminal.scrollTop=terminal.scrollHeight;

        addToHistory(cmd);
        commandBuffer=''; cursorPos=0; renderCommand();

        switch(cmd.toLowerCase()){
            case 'connect': connectSocket(); break;
            case 'exit': case 'quit': disconnectSocket(); break;
            case 'clear': clearTerminal(); break;
            case 'help': showHelp(); break;
            default:
                if(socket && socket.readyState===WebSocket.OPEN) socket.send(cmd);
                else appendToTerminal('${i18n.notConnectedError}','error');
        }
    }

    function showHelp(){
        appendToTerminal("${i18n.helpText}",'system');
        appendToTerminal("┌─────────────────────────────────────────────────────────────────────────────────────────────┐",'default');
        appendToTerminal("  connect                                     ${i18n.connectCmd}                              ",'info');
        appendToTerminal("  exit/quit                                   ${i18n.exitCmd}                                ",'info');
        appendToTerminal("  clear                                       ${i18n.clearCmd}                               ",'info');
        appendToTerminal("  help                                        ${i18n.helpCmd}                                ",'info');
        appendToTerminal("  ls [path]                                   ${i18n.lsCmd}                                  ",'info');
        appendToTerminal("  lsm                                         ${i18n.lsmCmd}                                 ",'info');
        appendToTerminal("  monitor [path] [param | result | time | ex] ${i18n.monitorCmd}                             ",'info');
        appendToTerminal("                                              ${i18n.monitorExample}                         ",'info');
        appendToTerminal("  remove [path]                               ${i18n.removeCmd}                              ",'info');
        appendToTerminal("                                              ${i18n.removeExample}                          ",'info');
        appendToTerminal("  removeall                                   ${i18n.removeAllCmd}                            ",'info');
        appendToTerminal("└─────────────────────────────────────────────────────────────────────────────────────────────┘",'default');
        appendToTerminal("${i18n.tips}",'info');
    }

    // ---------- 粘贴支持 ----------
    hiddenInput.addEventListener('paste', e => {
        e.preventDefault();
        const pasteText = (e.clipboardData || window.clipboardData).getData('text');
        commandBuffer = commandBuffer.slice(0, cursorPos) + pasteText + commandBuffer.slice(cursorPos);
        cursorPos += pasteText.length;
        renderCommand();
    });

    // ---------- 输入事件 ----------
    hiddenInput.addEventListener('keydown', e=>{
        const val = commandBuffer;
        const moveWordLeft = ()=>{
            const left = val.slice(0,cursorPos);
            const match = left.match(/(\S+)\s*$/);
            cursorPos = match ? cursorPos - match[0].length : 0;
        };
        const moveWordRight = ()=>{
            const right = val.slice(cursorPos);
            const match = right.match(/^\s*(\S+)/);
            cursorPos += match ? match[0].length : right.length;
        };

        if(e.key.length===1 && !e.ctrlKey && !e.metaKey){
            commandBuffer = val.slice(0,cursorPos)+e.key+val.slice(cursorPos);
            cursorPos++; renderCommand(); e.preventDefault();
        } else if(e.key==='Backspace'){
            if(cursorPos>0){ commandBuffer=val.slice(0,cursorPos-1)+val.slice(cursorPos); cursorPos--; renderCommand(); }
            e.preventDefault();
        } else if(e.key==='Delete'){
            commandBuffer=val.slice(0,cursorPos)+val.slice(cursorPos+1); renderCommand(); e.preventDefault();
        } else if(e.key==='ArrowLeft'){
            if(e.ctrlKey){ moveWordLeft(); } else if(cursorPos>0){ cursorPos--; }
            renderCommand(); e.preventDefault();
        } else if(e.key==='ArrowRight'){
            if(e.ctrlKey){ moveWordRight(); } else if(cursorPos<commandBuffer.length){ cursorPos++; }
            renderCommand(); e.preventDefault();
        } else if(e.key==='ArrowUp'){
            if(commandHistory.length){
                if(historyIndex===-1) historyIndex=commandHistory.length;
                if(historyIndex>0) historyIndex--;
                commandBuffer=commandHistory[historyIndex]; cursorPos=commandBuffer.length; renderCommand();
            }
            e.preventDefault();
        } else if(e.key==='ArrowDown'){
            if(historyIndex>=0 && historyIndex<commandHistory.length-1){ historyIndex++; commandBuffer=commandHistory[historyIndex]; }
            else{ commandBuffer=''; historyIndex=-1; }
            cursorPos=commandBuffer.length; renderCommand(); e.preventDefault();
        } else if(e.ctrlKey && e.key==='d'){ appendToTerminal('${i18n.exitShortcut}','info'); disconnectSocket(); }
        else if(e.ctrlKey && e.key==='u'){ commandBuffer=''; cursorPos=0; renderCommand(); e.preventDefault(); } // Ctrl+U 清空
        else if(e.key==='Home'){ cursorPos=0; renderCommand(); e.preventDefault(); }
        else if(e.key==='End'){ cursorPos=commandBuffer.length; renderCommand(); e.preventDefault(); }
        else if(e.key==='Enter'){ executeCommand(commandBuffer.trim()); e.preventDefault(); }
    });

    function focusHiddenInput(){ if(window.getSelection().toString().length===0) hiddenInput.focus(); }
    document.querySelector('.terminal-border').addEventListener('click',focusHiddenInput);
    window.addEventListener('DOMContentLoaded',()=>{ requestAnimationFrame(focusHiddenInput); });
    setInterval(()=>{ if(document.hasFocus()) focusHiddenInput(); renderCommand(); },500);

    // ---------- 欢迎信息 ----------
    appendToTerminal(
        "  ,---.                             ,--.                 \n"+
        " /  O  \\ ,--.--. ,---.,--.,--. ,---.|  |    ,---. ,---.  \n"+
        "|  .-.  ||  .--'| .-. |  ||  |(  .-'|  |   | .-. | .-. | \n"+
        "|  | |  ||  |   ' '-' '  ''  '.-'  `)  '--.' '-' ' '-' ' \n"+
        "`--' `--'`--'   .`-  / `----' `----'`-----' `---'.`-  /  \n"+
        "                `---'                            `---'  "
        ,'info',false);
    appendToTerminal("${i18n.helpCommand}",'info',false);

    renderCommand();
</script>
</body>
</html>
