<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argus Terminal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Fira Code', 'Courier New', monospace;
        }

        body {
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a, #0c0c0c);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #e0e0e0;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                    radial-gradient(circle at 20% 30%, rgba(0, 255, 200, 0.03) 0%, transparent 25%),
                    radial-gradient(circle at 80% 70%, rgba(100, 100, 255, 0.03) 0%, transparent 25%);
            pointer-events: none;
            z-index: -1;
        }

        .terminal-header {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(60, 200, 150, 0.3);
            flex-shrink: 0;
            box-shadow: 0 2px 15px rgba(0, 255, 200, 0.1);
            border-radius: 8px 8px 0 0;
            margin: 10px 10px 0 10px;
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        .terminal-title {
            font-weight: 500;
            color: #00ffc8;
            font-size: 14px;
            letter-spacing: 0.5px;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.5);
            font-weight: 600;
        }

        .terminal-controls {
            display: flex;
        }

        .control {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .close {
            background-color: #ff5f56;
            box-shadow: 0 0 8px rgba(255, 95, 86, 0.6);
        }
        .minimize {
            background-color: #ffbd2e;
            box-shadow: 0 0 8px rgba(255, 189, 46, 0.6);
        }
        .maximize {
            background-color: #27c93f;
            box-shadow: 0 0 8px rgba(39, 201, 63, 0.6);
        }

        .control:hover {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
        }

        .terminal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(60, 200, 150, 0.2);
            border-radius: 0 0 8px 8px;
            margin: 0 10px 0 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            text-align: center;
            background: rgba(20, 20, 20, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(60, 200, 150, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .login-title {
            color: #00ffc8;
            margin-bottom: 24px;
            font-size: 22px;
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 200, 0.5);
            background: linear-gradient(90deg, #00ffc8, #00b8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-form {
            background: rgba(30, 30, 30, 0.8);
            padding: 24px;
            border: 1px solid rgba(60, 200, 150, 0.3);
            border-radius: 8px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 15px rgba(0, 255, 200, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .input-group {
            margin-bottom: 18px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 6px;
            color: #00ffc8;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(60, 200, 150, 0.5);
            color: #00ffc8;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 200, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .input-field:focus {
            outline: none;
            border-color: #00ffc8;
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.3);
            transform: translateY(-1px);
        }

        .btn {
            background: rgba(0, 255, 200, 0.1);
            color: #00ffc8;
            border: 1px solid rgba(0, 255, 200, 0.5);
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.1);
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.5);
        }

        .btn:hover {
            background: rgba(0, 255, 200, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 200, 0.2);
        }

        .btn:disabled {
            background: rgba(60, 60, 60, 0.5);
            color: #333;
            border-color: #4d4d4d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .terminal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 12px;
            overflow: hidden;
            background: rgba(15, 15, 15, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(60, 200, 150, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .output-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            padding: 10px;
            background: rgba(20, 20, 20, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(60, 200, 150, 0.2);
            cursor: text;
        }

        .output-container::-webkit-scrollbar {
            width: 8px;
        }

        .output-container::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 4px;
        }

        .output-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ffc8, #00b8ff);
            border-radius: 4px;
            border: 1px solid rgba(0, 255, 200, 0.3);
        }

        .output-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00b8ff, #00ffc8);
        }

        .output {
            margin-bottom: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .output.error {
            color: #ff5f56 !important;
        }

        .output.success {
            color: #00ffc8 !important;
            font-weight: 500;
        }

        .command-line {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt {
            color: #00ffc8;
            margin-right: 8px;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
            font-family: 'Fira Code', 'Courier New', monospace;
            letter-spacing: 0.5px;
            cursor: text;
        }

        .input-line {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .command-input-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
            flex-grow: 1;
        }

        .command-input {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1;
            white-space: nowrap;
            overflow: visible;
            letter-spacing: 0;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
            color: #e0e0e0;
            width: 100%;
            outline: none;
            height: 18px;
            min-height: 18px;
            max-height: 18px;
            flex-shrink: 0;
        }

        .response {
            color: #b5b5b5;
        }

        .warn {
            color: #bb8240;
        }

        .command {
            color: #b0b0b0;
        }

        .terminal-footer {
            padding: 8px 12px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(45, 217, 155, 0.3);
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            flex-shrink: 0;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.3);
            border-radius: 0 0 8px 8px;
            margin: 0 10px 10px 10px;
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .connected {
            background-color: #00ffc8;
            box-shadow: 0 0 8px rgba(0, 255, 200, 0.6);
            animation: pulse 1.5s infinite;
        }

        .disconnected {
            background-color: #ff5f56;
            box-shadow: 0 0 8px rgba(255, 95, 86, 0.6);
        }

        .connecting {
            background-color: #ffbd2e;
            box-shadow: 0 0 8px rgba(255, 189, 46, 0.6);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .token-info {
            display: flex;
            align-items: center;
            margin-left: 12px;
        }

        .token-expiry {
            margin-left: 5px;
            color: #00ffc8;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 255, 200, 0.3);
            border-radius: 50%;
            border-top-color: #00ffc8;
            animation: spin 1s ease-in-out infinite;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(0, 255, 200, 0.2);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .login-message {
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        .output-container::after {
            content: '';
            display: block;
            height: 20px;
        }

        @media (max-width: 768px) {
            .terminal-header {
                padding: 6px 10px;
            }

            .login-form {
                padding: 18px;
            }

            .login-title {
                font-size: 20px;
            }

            .terminal-footer {
                flex-direction: column;
                gap: 8px;
            }

            .terminal-body {
                margin: 0 5px 0 5px;
            }

            .terminal-header,
            .terminal-footer {
                margin: 5px;
            }
        }
        /* 在样式部分添加以下代码 */
        .copy-button-container {
            position: relative;
            display: inline-block;
        }

        .copy-button {
            display: none;
            position: absolute;
            right: -70px;
            top: 50%;
            transform: translateY(-50%);
            padding: 2px 6px;
            font-size: 0.85em;
            background: rgba(0, 255, 200, 0.1);
            color: #00ffc8;
            border: 1px solid rgba(0, 255, 200, 0.1);
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.9;
            transition: all 0.2s ease;
            z-index: 10;
            white-space: nowrap;
        }

        .copy-button:hover {
            background: rgba(0, 255, 200, 0.2);
            box-shadow: 0 0 8px rgba(0, 255, 200, 0.3);
        }

        .copy-content {
            display: inline;
            color: #00ffc8;
            font-weight: 500;
            background: rgba(0, 255, 200, 0.1);
            padding: 2px 4px;
            border-radius: 4px;
            margin: 0 2px;
            border: 1px solid rgba(0, 255, 200, 0.1);
            white-space: pre;
            line-height: 1.4;
        }

        .copy-button-container:hover .copy-button {
            display: block;
        }

        .copy-button-container:hover .copy-content {
            background: rgba(0, 255, 200, 0.2);
            box-shadow: 0 0 8px rgba(0, 255, 200, 0.3);
        }
        .login-message.error {
            color: #ff5f56 !important; /* 红色文字 */
            background: rgba(255, 95, 86, 0.1); /* 淡红背景 */
            border-color: rgba(255, 95, 86, 0.3);
            text-shadow: 0 0 5px rgba(255, 95, 86, 0.2);
        }
    </style>
</head>
<body>
<div class="terminal-header">
    <div class="terminal-title">Argus Terminal <span class="version">v1.0</span></div>
    <div class="terminal-controls">
        <!-- Controls hidden -->
    </div>
</div>

<div class="terminal-body" id="terminalBody">
    <div class="login-container" id="loginContainer">
        <h1 class="login-title">ARGUS TERMINAL</h1>
        <div class="login-form">
            <div class="input-group">
                <label class="input-label">用户名</label>
                <input type="text" class="input-field" id="username" placeholder="输入用户名" value="">
            </div>
            <div class="input-group">
                <label class="input-label">密码</label>
                <input type="password" class="input-field" id="password" placeholder="输入密码" value="">
            </div>
            <button class="btn" id="loginBtn">
                <span id="loginText">登录</span>
                <span id="loginSpinner" class="loading" style="display: none;"></span>
            </button>
            <div id="loginMessage" class="login-message"></div>
        </div>
    </div>

    <div id="terminalOutput" class="terminal-content" style="display: none;">
        <div class="output-container" id="outputContainer">
            <div class="output" id="commandHistory"></div>

            <div class="command-line">
                <span class="prompt">
                    <span class="user-host">argus@${currentUser}</span> %
                </span>
                <div class="input-line">
                    <div class="command-input-wrapper">
                        <input type="text" class="command-input" id="commandInput" autocomplete="off">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="terminal-footer">
    <div style="display: flex; align-items: center;">
        <div class="connection-status">
            <div class="status-indicator disconnected" id="statusIndicator"></div>
            <span id="statusText">未连接</span>
        </div>
        <div class="token-info" id="tokenInfo" style="display: none;">
            <i class="fas fa-key"></i>
            <span class="token-expiry" id="tokenExpiry"></span>
        </div>
    </div>
</div>

<script>
    let authToken = null;
    let tokenExpiry = null;
    let tokenTimer = null;
    let tokenInterval = null;
    let isConnected = false;
    let currentUser = '';
    let commandIndex = -1;
    let commands = [];
    let websocket = null;
    let isReconnecting = false;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    const BASE_RECONNECT_DELAY = 2000;

    function getContextPath() {
        const fullPath = window.location.pathname;
        const terminalIndex = fullPath.indexOf('/argus/index.html');
        return terminalIndex > 0 ? fullPath.substring(0, terminalIndex) : '';
    }

    function getWebSocketUrl() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const contextPath = getContextPath();
        return `${protocol}//${host}${contextPath}/argus-ws`;
    }

    function scrollToBottom() {
        const outputContainer = document.getElementById('outputContainer');
        outputContainer.scrollTop = outputContainer.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const loginContainer = document.getElementById('loginContainer');
        const terminalOutput = document.getElementById('terminalOutput');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginMessage = document.getElementById('loginMessage');
        const commandHistory = document.getElementById('commandHistory');
        const userHost = document.querySelector('.user-host');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const tokenInfo = document.getElementById('tokenInfo');
        const tokenExpiryElement = document.getElementById('tokenExpiry');

        checkExistingToken();

        loginBtn.addEventListener('click', handleLogin);
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });

        function checkExistingToken() {
            const token = localStorage.getItem('argus-token');
            const expiry = localStorage.getItem('argus-token-expiry');
            if (token && expiry) {
                const expiryTime = parseInt(expiry);
                const currentTime = new Date().getTime();
                if (currentTime < expiryTime) {
                    authToken = token;
                    startTokenTimer(expiryTime - currentTime);
                    showTerminal();
                    connectWebSocket();

                    // ✅ 新增：恢复 token 显示
                    const tokenInfo = document.getElementById('tokenInfo');
                    const tokenExpiryElement = document.getElementById('tokenExpiry');
                    tokenInfo.style.display = 'flex';
                    updateTokenExpiryDisplay(expiryTime);  // 注意：传入的是绝对时间戳

                    // 可选：恢复用户名
                    const storedUsername = localStorage.getItem('argus-username');
                    if (storedUsername) {
                        currentUser = storedUsername;
                        const userHost = document.querySelector('.user-host');
                        if (userHost) userHost.textContent = `argus@${currentUser}`;
                    }
                } else {
                    localStorage.removeItem('argus-token');
                    localStorage.removeItem('argus-token-expiry');
                    localStorage.removeItem('argus-username');
                }
            }
        }

        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();
            // if (!username || !password) {
            //     showLoginMessage('请输入用户名和密码', 'error');
            //
            //     return;
            // }

            loginText.textContent = '登录中...';
            loginSpinner.style.display = 'inline-block';
            loginBtn.disabled = true;
            loginMessage.textContent = '';
            loginMessage.style.display = 'none';

            fetch(getContextPath() + '/argus/login', {
                method: 'POST',
                headers: {
                    'username': username,
                    'password': password
                }
            })
                .then(response => {
                    if (response.status === 200) {
                        const token = response.headers.get('argus-token');
                        const expireTime = response.headers.get('argus-token-expire-time');
                        if (token && expireTime) {
                            authToken = token;
                            const expiry = parseInt(expireTime);
                            localStorage.setItem('argus-token', token);
                            localStorage.setItem('argus-token-expiry', expiry.toString());
                            startTokenTimer(expiry - new Date().getTime());
                            currentUser = username;
                            if (userHost) userHost.textContent = `argus@${currentUser}`;
                            showTerminal();
                            tokenInfo.style.display = 'flex';
                            if (tokenInterval) clearInterval(tokenInterval);
                            updateTokenExpiryDisplay(expiry);
                            connectWebSocket();
                            document.getElementById("commandInput").focus();
                        } else {
                            throw new Error('用户名或密码错误');
                        }
                    } else {
                        throw new Error('登录失败，状态码: ' + response.status);
                    }
                })
                .catch(error => {
                    showLoginMessage(error.message, 'error');
                })
                .finally(() => {
                    loginText.textContent = '登录';
                    loginSpinner.style.display = 'none';
                    loginBtn.disabled = false;
                });
        }

        function validateToken(callback) {
            if (!authToken) return callback(false);
            fetch(getContextPath() + '/argus/validateToken', {
                method: 'GET',
                headers: { 'argus-token': authToken }
            }).then(r => callback(r.status === 200)).catch(() => callback(false));
        }

        function connectWebSocket() {
            if (!authToken) return;
            validateToken(valid => {
                if (!valid) {
                    addOutput('身份验证失败，无法连接', 'error');
                    setTimeout(logout, 1500);
                    return;
                }
                statusIndicator.classList.remove('connected', 'disconnected');
                statusIndicator.classList.add('connecting');
                statusText.textContent = '连接中...';
                const wsUrl = `${getWebSocketUrl()}?argus-token=${encodeURIComponent(authToken)}`;
                websocket = new WebSocket(wsUrl);

                websocket.onopen = () => {
                    isConnected = true;
                    isReconnecting = false;
                    reconnectAttempts = 0;
                    statusIndicator.classList.remove('connecting', 'disconnected');
                    statusIndicator.classList.add('connected');
                    statusText.textContent = '已连接';
                    addOutput("已连接 argus", 'success');
                    addOutput("输入 'help' 查看命令列表。", 'info');
                };

                // 处理成功消息
                function handleSuccessOutput(data) {
                    const commandHistory = document.getElementById('commandHistory');

                    // 创建内容行
                    const outputDiv = document.createElement('div');
                    outputDiv.className = 'output response content';
                    outputDiv.style.whiteSpace = 'pre-wrap';
                    outputDiv.style.wordBreak = 'break-all';
                    outputDiv.style.fontFamily = 'Fira Code, monospace';
                    outputDiv.style.lineHeight = '1.5';

                    const START_TAG = '#copystart#';
                    const END_TAG = '#copyend#';
                    let index = 0;
                    let lastIndex = 0;

                    while (index < data.length) {
                        const startIdx = data.indexOf(START_TAG, index);
                        if (startIdx === -1) break;
                        if (startIdx > lastIndex) {
                            const text = data.slice(lastIndex, startIdx);
                            outputDiv.appendChild(document.createTextNode(text));
                        }
                        const endIdx = data.indexOf(END_TAG, startIdx + START_TAG.length);
                        if (endIdx === -1) {
                            outputDiv.appendChild(document.createTextNode(data.slice(startIdx)));
                            break;
                        }
                        const innerContent = data.slice(startIdx + START_TAG.length, endIdx);
                        const hasValidContent = innerContent.trim() !== '';
                        if (hasValidContent) {
                            const copyText = document.createElement('span');
                            copyText.textContent = innerContent;
                            copyText.style.cssText = `
                display: inline;
                color: #00ffc8;
                font-weight: 500;
                background: rgba(0, 255, 200, 0.1);
                padding: 2px 4px;
                border-radius: 4px;
                margin: 0 2px;
                border: 1px solid rgba(0, 255, 200, 0.1);
                white-space: pre;
                line-height: 1.4;
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
            `;

                            const tooltip = document.createElement('span');
                            tooltip.textContent = '点击即可复制';
                            tooltip.style.cssText = `
                position: fixed;
                background: rgba(0, 0, 0, 0.8);
                color: #00ffc8;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                opacity: 0;
                transition: opacity 0.2s ease;
                pointer-events: none;
                z-index: 1000;
                top: 0;
                left: 0;
            `;
                            document.body.appendChild(tooltip);

                            copyText.addEventListener('mousemove', (e) => {
                                tooltip.style.top = (e.clientY - 10) + 'px';
                                tooltip.style.left = (e.clientX + 15) + 'px';
                            });
                            copyText.addEventListener('mouseenter', (e) => {
                                copyText.style.background = 'rgba(0, 255, 200, 0.2)';
                                copyText.style.boxShadow = '0 0 8px rgba(0, 255, 200, 0.3)';
                                tooltip.style.top = (e.clientY - 10) + 'px';
                                tooltip.style.left = (e.clientX + 15) + 'px';
                                tooltip.style.opacity = '1';
                            });
                            copyText.addEventListener('mouseleave', () => {
                                copyText.style.background = 'rgba(0, 255, 200, 0.1)';
                                copyText.style.boxShadow = 'none';
                                tooltip.style.opacity = '0';
                            });
                            copyText.addEventListener('click', (e) => {
                                e.stopPropagation();
                                navigator.clipboard.writeText(innerContent).then(() => {
                                    const originalText = tooltip.textContent;
                                    tooltip.textContent = '✓ 已复制';
                                    tooltip.style.opacity = '1';
                                    setTimeout(() => {
                                        tooltip.textContent = originalText;
                                        tooltip.style.opacity = '0';
                                    }, 1500);
                                }).catch(err => {
                                    console.error('复制失败:', err);
                                    const originalText = tooltip.textContent;
                                    tooltip.textContent = '✗ 复制失败';
                                    tooltip.style.opacity = '1';
                                    setTimeout(() => {
                                        tooltip.textContent = originalText;
                                        tooltip.style.opacity = '0';
                                    }, 1500);
                                });
                            });

                            outputDiv.appendChild(copyText);
                        }
                        lastIndex = endIdx + END_TAG.length;
                        index = lastIndex;
                    }

                    if (lastIndex < data.length) {
                        const remaining = data.slice(lastIndex);
                        const coloredText = parseColorTags(remaining);
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = coloredText;
                        while (tempDiv.firstChild) {
                            outputDiv.appendChild(tempDiv.firstChild);
                        }
                    }

                    commandHistory.appendChild(outputDiv);
                    scrollToBottom();
                }

                // 处理消息
                websocket.onmessage = (event) => {
                    try {
                        const message = event.data;
                        // 仅处理含 #ouputconcat# 的消息
                        if (!message.includes('#ouputconcat#')) {
                            addOutput(message);
                            return;
                        }
                        // 提取 code 和 data
                        const codeMatch = message.match(/^code=(\d+)#ouputconcat#data=(.*)/s);
                        if (!codeMatch) {
                            addOutput('协议错误：无法解析消息', 'error');
                            return;
                        }
                        const code = parseInt(codeMatch[1], 10);
                        const data = codeMatch[2];

                        // 获取当前时间 HH:MM:SS
                        const now = new Date();
                        const timeStr = now.getHours().toString().padStart(2, '0') +
                            ':' + now.getMinutes().toString().padStart(2, '0') +
                            ':' + now.getSeconds().toString().padStart(2, '0');

                        if (code === 1) {
                            // 成功响应：时间 + 内容（换行）
                            const timeDiv = document.createElement('div');
                            timeDiv.className = 'output response time-stamp';
                            timeDiv.style.color = '#00b8ff';
                            timeDiv.style.opacity = '0.9';
                            timeDiv.style.fontWeight = '500';
                            timeDiv.style.marginBottom = '4px';
                            timeDiv.style.userSelect = 'none';
                            timeDiv.textContent = timeStr;
                            commandHistory.appendChild(timeDiv);

                            // 调用原有的 handleSuccessOutput 处理内容
                            handleSuccessOutput(data);
                        } else {
                            // 错误响应：时间 + 错误内容（换行）
                            const timeDiv = document.createElement('div');
                            timeDiv.className = 'output error time-stamp';
                            timeDiv.style.color = '#ff5f56'; // 红色
                            timeDiv.style.opacity = '0.9';
                            timeDiv.style.fontWeight = '500';
                            timeDiv.style.marginBottom = '4px';
                            timeDiv.style.userSelect = 'none';
                            timeDiv.textContent = timeStr;
                            commandHistory.appendChild(timeDiv);

                            // 创建错误内容行
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'output error content';
                            errorDiv.style.whiteSpace = 'pre-wrap';
                            errorDiv.style.wordBreak = 'break-all';
                            errorDiv.style.fontFamily = 'Fira Code, monospace';
                            errorDiv.style.lineHeight = '1.5';
                            errorDiv.style.color = '#ff5f56'; // 红色文本

                            // 直接设置错误文本
                            errorDiv.textContent = data;

                            commandHistory.appendChild(errorDiv);
                            scrollToBottom();
                        }
                    } catch (e) {
                        // 连这个都错了，直接用基础函数输出
                        addOutput(`解析消息失败: ${e.message}`, 'error');
                    }
                };
                websocket.onclose = (event) => {
                    isConnected = false;
                    statusIndicator.classList.remove('connecting', 'connected');
                    statusIndicator.classList.add('disconnected');
                    statusText.textContent = '未连接';
                    if (event.wasClean && event.code === 1000) {
                        addOutput(`已断开 argus 连接: ${event.code} ${event.reason || ''}`, 'info');
                    } else if (event.code === 1001) {
                        addOutput(`argus 断开: ${event.code} ${event.reason || ''}`, 'error');
                        attemptReconnect();
                    } else {
                        addOutput('连接 argus 异常断开，正在重试...', 'error');
                        attemptReconnect();
                    }
                };

                websocket.onerror = (err) => {
                    console.error('WebSocket错误:', err);
                    addOutput('连接 argus 错误', 'error');
                };
            });
        }

        function attemptReconnect() {
            if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS || isReconnecting) {
                addOutput('重连失败次数过多，正在跳转至登录页面...', 'error');
                setTimeout(logout, 1500);
                return;
            }
            isReconnecting = true;
            reconnectAttempts++;
            const delay = BASE_RECONNECT_DELAY * Math.pow(2, reconnectAttempts - 1);
            addOutput(`第 ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS} 次重连尝试...`, 'info');
            setTimeout(() => {
                isReconnecting = false;
                connectWebSocket();
            }, delay);
        }

        function sendCommand(command) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addOutput('未连接，请先使用 connect 连接', 'error');
                return false;
            }
            try {
                websocket.send(command);
                return true;
            } catch (error) {
                addOutput(error.message, 'error');
                return false;
            }
        }

        function showLoginMessage(message, type = 'response') {
            loginMessage.textContent = message;
            loginMessage.className = `login-message ${type}`;
            loginMessage.style.display = 'block';
        }

        function startTokenTimer(expireTime) {
            if (tokenTimer) clearTimeout(tokenTimer);
            tokenTimer = setTimeout(() => {
                addOutput('登录已过期，请重新登录', 'error');
                logout();
            }, expireTime);
        }

        function updateTokenExpiryDisplay(expiry) {
            if (tokenInterval) clearInterval(tokenInterval);
            const update = () => {
                const now = Date.now();
                const remaining = expiry - now;
                if (remaining <= 0) {
                    tokenExpiryElement.textContent = '已过期';
                    return;
                }
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                tokenExpiryElement.textContent = `Token剩余: ${minutes}分${seconds}秒`;
            };
            update();
            tokenInterval = setInterval(update, 1000);
        }

        function showTerminal() {
            loginContainer.style.display = 'none';
            terminalOutput.style.display = 'flex';
            addCommandInputLine();
        }

        function logout() {
            if (websocket) websocket.close();
            authToken = null;
            localStorage.removeItem('argus-token');
            localStorage.removeItem('argus-token-expiry');
            if (tokenTimer) clearTimeout(tokenTimer);
            if (tokenInterval) clearInterval(tokenInterval);
            loginContainer.style.display = 'flex';
            terminalOutput.style.display = 'none';
            tokenInfo.style.display = 'none';
            passwordInput.value = '';
        }

        terminalOutput.addEventListener('click', function(e) {
            const selection = window.getSelection();
            const input = document.getElementById('commandInput');
            if (selection.toString().length > 0) return;
            if (e.target === input || input.contains(e.target)) return;
            if (e.target.closest('.prompt') || e.target === document.getElementById('outputContainer')) {
                input.focus();
            }
        });

        function addOutput(text, type = 'response') {
            const div = document.createElement('div');
            div.className = `output ${type}`;
            div.textContent = text;
            commandHistory.appendChild(div);
            scrollToBottom();
        }

        function parseColorTags(text) {
            if (!text || typeof text !== 'string') return text;

            return text.replace(/\[#([0-9A-Fa-f]{6})\](.*?)\[\/\]/g, (match, color, content) => {
                return `<span style="
            color: #${color};
            font-weight: 600;
            text-shadow: none;
            box-shadow: none;
            border: none;
            background: none;
            padding: 0;
            margin: 0;
        ">${escapeHtml(content)}</span>`;
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addCommandInputLine() {
            const container = document.getElementById('outputContainer');
            const oldInput = document.getElementById('commandInput');
            if (oldInput && oldInput.closest('.command-line')) {
                oldInput.closest('.command-line').remove();
            }

            const line = document.createElement('div');
            line.className = 'command-line';
            line.innerHTML = `
                <span class="prompt">
                    <span class="user-host">argus@${currentUser}</span> %
                </span>
                <div class="input-line">
                    <div class="command-input-wrapper">
                        <input type="text" class="command-input" id="commandInput" autocomplete="off">
                    </div>
                </div>
            `;
            container.appendChild(line);

            const input = document.getElementById('commandInput');

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const command = input.value.trim();
                    if (command) {
                        commands.push(command);
                        commandIndex = commands.length;
                        addOutput(`argus@${currentUser}% ${command}`, 'command');
                        handleCommand(command);
                        input.value = '';
                        addCommandInputLine();
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (commands.length > 0 && commandIndex > 0) {
                        commandIndex--;
                        input.value = commands[commandIndex];
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (commandIndex < commands.length - 1) {
                        commandIndex++;
                        input.value = commands[commandIndex];
                    } else {
                        commandIndex = commands.length;
                        input.value = '';
                    }
                }
            });

            input.focus();
            scrollToBottom();
        }

        function handleCommand(command) {
            switch (command.toLowerCase()) {
                case 'clear':
                    commandHistory.innerHTML = '';
                    addCommandInputLine();
                    break;
                case 'connect':
                    if (!isConnected) connectWebSocket();
                    else addOutput('已连接', 'error');
                    break;
                case 'exit':
                    if (websocket) websocket.close();
                    break;
                case 'logout':
                    setTimeout(logout, 1000);
                    break;
                default:
                    sendCommand(command);
            }
        }
    });
</script>
</body>
</html>