<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argus Terminal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Fira Code', 'Courier New', monospace;
        }

        body {
            background: linear-gradient(135deg, #0c0c0c, #1a1a1a, #0c0c0c);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #e0e0e0;
            overflow: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                    radial-gradient(circle at 20% 30%, rgba(0, 255, 200, 0.03) 0%, transparent 25%),
                    radial-gradient(circle at 80% 70%, rgba(100, 100, 255, 0.03) 0%, transparent 25%);
            pointer-events: none;
            z-index: -1;
        }

        .terminal-header {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(60, 200, 150, 0.3);
            flex-shrink: 0;
            box-shadow: 0 2px 15px rgba(0, 255, 200, 0.1);
            border-radius: 8px 8px 0 0;
            margin: 10px 10px 0 10px;
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        .terminal-title {
            font-weight: 500;
            color: #00ffc8;
            font-size: 14px;
            letter-spacing: 0.5px;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.5);
            font-weight: 600;
        }

        .terminal-controls {
            display: flex;
        }

        .control {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .close {
            background-color: #ff5f56;
            box-shadow: 0 0 8px rgba(255, 95, 86, 0.6);
        }
        .minimize {
            background-color: #ffbd2e;
            box-shadow: 0 0 8px rgba(255, 189, 46, 0.6);
        }
        .maximize {
            background-color: #27c93f;
            box-shadow: 0 0 8px rgba(39, 201, 63, 0.6);
        }

        .control:hover {
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.6);
        }

        .terminal-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px;
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(60, 200, 150, 0.2);
            border-radius: 0 0 8px 8px;
            margin: 0 10px 0 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding: 20px;
            text-align: center;
            background: rgba(20, 20, 20, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(60, 200, 150, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .login-title {
            color: #00ffc8;
            margin-bottom: 24px;
            font-size: 22px;
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 255, 200, 0.5);
            background: linear-gradient(90deg, #00ffc8, #00b8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-form {
            background: rgba(30, 30, 30, 0.8);
            padding: 24px;
            border: 1px solid rgba(60, 200, 150, 0.3);
            border-radius: 8px;
            width: 100%;
            max-width: 380px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 15px rgba(0, 255, 200, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .input-group {
            margin-bottom: 18px;
            text-align: left;
        }

        .input-label {
            display: block;
            margin-bottom: 6px;
            color: #00ffc8;
            font-size: 13px;
            font-weight: 500;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(60, 200, 150, 0.5);
            color: #00ffc8;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 200, 0.1);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .input-field:focus {
            outline: none;
            border-color: #00ffc8;
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.3);
            transform: translateY(-1px);
        }

        .btn {
            background: rgba(0, 255, 200, 0.1);
            color: #00ffc8;
            border: 1px solid rgba(0, 255, 200, 0.5);
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            width: 100%;
            font-size: 14px;
            border-radius: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 255, 200, 0.1);
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.5);
        }

        .btn:hover {
            background: rgba(0, 255, 200, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 200, 0.2);
        }

        .btn:disabled {
            background: rgba(60, 60, 60, 0.5);
            color: #333;
            border-color: #4d4d4d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .terminal-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 12px;
            overflow: hidden;
            background: rgba(15, 15, 15, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(60, 200, 150, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .output-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            padding: 10px;
            background: rgba(20, 20, 20, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        .output-container::-webkit-scrollbar {
            width: 8px;
        }

        .output-container::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.8);
            border-radius: 4px;
        }

        .output-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00ffc8, #00b8ff);
            border-radius: 4px;
            border: 1px solid rgba(0, 255, 200, 0.3);
        }

        .output-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00b8ff, #00ffc8);
        }

        .output {
            margin-bottom: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            font-size: 14px;
        }

        .command-line {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt {
            color: #00ffc8;
            margin-right: 8px;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
            font-family: 'Fira Code', 'Courier New', monospace;
            letter-spacing: 0.5px;
        }

        .input-line {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .command-input {
            background: transparent;
            border: none;
            color: #e0e0e0;
            font-size: 14px;
            width: 100%;
            outline: none;
            caret-color: #00ffc8;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
            font-weight: 500;
        }

        .response {
            color: #e0e0e0;
        }

        .error {
            color: #ff5f56;
        }

        .success {
            color: #00ffc8;
            font-weight: 500;
        }

        .command {
            color: #b0b0b0;
        }

        .welcome-message {
            margin-bottom: 15px;
            color: #00ffc8;
            font-size: 15px;
            text-align: center;
            text-shadow: 0 0 8px rgba(0, 255, 200, 0.3);
            font-weight: 500;
        }

        .terminal-footer {
            padding: 8px 12px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(60, 200, 150, 0.3);
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            flex-shrink: 0;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.3);
            border-radius: 0 0 8px 8px;
            margin: 0 10px 10px 10px;
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .connected {
            background-color: #00ffc8;
            box-shadow: 0 0 8px rgba(0, 255, 200, 0.6);
            animation: pulse 1.5s infinite;
        }

        .disconnected {
            background-color: #ff5f56;
            box-shadow: 0 0 8px rgba(255, 95, 86, 0.6);
        }

        .connecting {
            background-color: #ffbd2e;
            box-shadow: 0 0 8px rgba(255, 189, 46, 0.6);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .token-info {
            display: flex;
            align-items: center;
            margin-left: 12px;
        }

        .token-expiry {
            margin-left: 5px;
            color: #00ffc8;
            text-shadow: 0 0 5px rgba(0, 255, 200, 0.3);
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0, 255, 200, 0.3);
            border-radius: 50%;
            border-top-color: #00ffc8;
            animation: spin 1s ease-in-out infinite;
            margin-right: 6px;
            box-shadow: 0 0 8px rgba(0, 255, 200, 0.2);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ascii-art {
            color: #00ffc8;
            font-family: 'Courier New', monospace;
            line-height: 1.2;
            margin: 15px 0;
            white-space: pre;
            overflow: hidden;
            text-align: center;
            font-size: 12px;
            text-shadow: 0 0 8px rgba(0, 255, 200, 0.3);
            opacity: 0.8;
        }

        .developer-info {
            color: #00b8ff;
            text-align: center;
            margin-top: 8px;
            font-style: italic;
            font-size: 12px;
            opacity: 0.8;
            text-shadow: 0 0 5px rgba(0, 184, 255, 0.3);
        }

        .login-message {
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(60, 200, 150, 0.2);
        }

        @media (max-width: 768px) {
            .terminal-header {
                padding: 6px 10px;
            }

            .login-form {
                padding: 18px;
            }

            .login-title {
                font-size: 20px;
            }

            .terminal-footer {
                flex-direction: column;
                gap: 8px;
            }

            .ascii-art {
                font-size: 10px;
            }

            .terminal-body {
                margin: 0 5px 0 5px;
            }

            .terminal-header,
            .terminal-footer {
                margin: 5px;
            }
        }
    </style>
</head>
<body>
<div class="terminal-header">
    <div class="terminal-title">Argus Terminal <span class="version">v1.0</span></div>
    <div class="terminal-controls">
        <div class="control close" onclick="minimizeTerminal()"></div>
        <div class="control minimize" onclick="toggleFullscreen()"></div>
        <div class="control maximize" onclick="closeTerminal()"></div>
    </div>
</div>

<div class="terminal-body" id="terminalBody">
    <!-- 初始显示登录界面 -->
    <div class="login-container" id="loginContainer">
        <h1 class="login-title">ARGUS TERMINAL</h1>
        <div class="login-form">
            <div class="input-group">
                <label class="input-label">用户名</label>
                <input type="text" class="input-field" id="username" placeholder="输入用户名" value="admin">
            </div>
            <div class="input-group">
                <label class="input-label">密码</label>
                <input type="password" class="input-field" id="password" placeholder="输入密码" value="password">
            </div>
            <button class="btn" id="loginBtn">
                <span id="loginText">登录</span>
                <span id="loginSpinner" class="loading" style="display: none;"></span>
            </button>
            <div id="loginMessage" class="login-message"></div>
        </div>
    </div>

    <!-- 终端输出区域，初始隐藏 -->
    <div id="terminalOutput" class="terminal-content" style="display: none;">
        <div class="output-container" id="outputContainer">
            <div class="ascii-art">
            </div>
            <div class="output" id="commandHistory"></div>

            <div class="command-line">
                <span class="prompt" id="userPrompt">user@argus:~$</span>
                <div class="input-line">
                    <input type="text" class="command-input" id="commandInput" autocomplete="off" autofocus>
                    <span class="cursor"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="terminal-footer">
    <div style="display: flex; align-items: center;">
        <div class="connection-status">
            <div class="status-indicator disconnected" id="statusIndicator"></div>
            <span id="statusText">未连接</span>
        </div>
        <div class="token-info" id="tokenInfo" style="display: none;">
            <i class="fas fa-key"></i>
            <span class="token-expiry" id="tokenExpiry"></span>
        </div>
    </div>
    <div class="terminal-mode">全屏模式</div>
</div>

<script>
    // 全局变量
    let authToken = null;
    let tokenExpiry = null;
    let tokenTimer = null;
    let tokenInterval = null; // 用于存储setInterval的引用
    let isConnected = false;
    let currentUser = '';
    let commandIndex = -1;
    let commands = [];
    let websocket = null;
    let cursorBlinkInterval = null;

    // 获取上下文路径
    function getContextPath() {
        const fullPath = window.location.pathname;
        const terminalIndex = fullPath.indexOf('/argus/index.html');
        return terminalIndex > 0 ? fullPath.substring(0, terminalIndex) : '';
    }

    // 获取WebSocket URL
    function getWebSocketUrl() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const contextPath = getContextPath();
        return `${protocol}//${host}${contextPath}/argus-ws`;
    }

    // 自动滚动到底部
    function scrollToBottom() {
        const outputContainer = document.getElementById('outputContainer');
        outputContainer.scrollTop = outputContainer.scrollHeight;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const loginContainer = document.getElementById('loginContainer');
        const terminalOutput = document.getElementById('terminalOutput');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const loginMessage = document.getElementById('loginMessage');
        const commandInput = document.getElementById('commandInput');
        const commandHistory = document.getElementById('commandHistory');
        const userPrompt = document.getElementById('userPrompt');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const tokenInfo = document.getElementById('tokenInfo');
        const tokenExpiryElement = document.getElementById('tokenExpiry');

        // 检查本地存储中是否有有效的token
        checkExistingToken();

        // 登录按钮点击事件
        loginBtn.addEventListener('click', handleLogin);

        // 回车键登录
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') handleLogin();
        });

        // 检查本地存储中是否有有效的token
        function checkExistingToken() {
            const token = localStorage.getItem('argus-token');
            const expiry = localStorage.getItem('argus-token-expiry');

            if (token && expiry) {
                const expiryTime = parseInt(expiry);
                const currentTime = new Date().getTime();

                if (currentTime < expiryTime) {
                    // Token仍然有效
                    authToken = token;
                    startTokenTimer(expiryTime - currentTime);
                    showTerminal();
                    connectWebSocket();
                } else {
                    // Token已过期，清除
                    localStorage.removeItem('argus-token');
                    localStorage.removeItem('argus-token-expiry');
                }
            }
        }

        // 处理登录
        function handleLogin() {
            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            if (!username || !password) {
                showLoginMessage('请输入用户名和密码', 'error');
                return;
            }

            // showTerminal()
            // 显示加载状态
            loginText.textContent = '登录中...';
            loginSpinner.style.display = 'inline-block';
            loginBtn.disabled = true;
            loginMessage.textContent = '';
            loginMessage.style.display = 'none';

            // 调用登录API
            fetch(getContextPath() + '/argus/login', {
                method: 'POST',
                headers: {
                    'username': username,
                    'password': password
                }
            })
                .then(response => {
                    if (response.status === 200) {
                        // 登录成功，获取token和过期时间
                        const token = response.headers.get('argus-token');
                        const expireTime = response.headers.get('argus-token-expire-time');

                        if (token && expireTime) {
                            // 保存token和过期时间
                            authToken = token;
                            const expiry = parseInt(expireTime);

                            // 存储到localStorage
                            localStorage.setItem('argus-token', token);
                            localStorage.setItem('argus-token-expiry', expiry.toString());

                            // 启动token过期计时器
                            startTokenTimer(expiry - new Date().getTime());

                            // 显示终端界面
                            showTerminal();

                            // 更新用户提示
                            currentUser = username;
                            userPrompt.textContent = `argus@${currentUser}:~$`;

                            // 显示token信息
                            tokenInfo.style.display = 'flex';

                            // 清除之前的定时器（如果存在）
                            if (tokenInterval) {
                                clearInterval(tokenInterval);
                                tokenInterval = null;
                            }

                            // 更新token过期时间显示
                            updateTokenExpiryDisplay(expiry);

                            // 建立WebSocket连接
                            connectWebSocket();
                        } else {
                            throw new Error('用户名或密码错误');
                        }
                    } else if (response.status === 401) {
                        throw new Error('用户名或密码错误');
                    } else {
                        throw new Error('登录失败，状态码: ' + response.status);
                    }
                })
                .catch(error => {
                    showLoginMessage(error.message, 'error');
                })
                .finally(() => {
                    // 恢复登录按钮状态
                    loginText.textContent = '登录';
                    loginSpinner.style.display = 'none';
                    loginBtn.disabled = false;
                });
        }

        // 建立WebSocket连接
        function connectWebSocket() {

            fetch('/argus/validateToken', {
                method: 'GET',
                headers: {
                    'argus-token': authToken  // 使用当前 token
                }
            })
                .then(response => {
                    if (response.status === 401) {
                        addOutput('登录已过期，无法建立连接。', 'error');
                        setTimeout(logout, 1000);
                        // 不继续连接
                        return false;
                    }
                })
                .catch(error => {
                    console.error('Token 校验请求失败:', error);
                    addOutput('网络错误，无法验证身份。', 'error');
                    setTimeout(logout, 1500); // 安全起见，登出
                });

            isConnected = true;
            // 更新连接状态
            statusIndicator.classList.remove('disconnected', 'connected');
            statusIndicator.classList.add('connecting');
            statusText.textContent = '连接中...';

            try {
                // 创建WebSocket连接，通过URL参数传递token
                const wsUrl = `${getWebSocketUrl()}?argus-token=${encodeURIComponent(authToken)}`;
                websocket = new WebSocket(wsUrl);

                // 连接建立时的处理
                websocket.onopen = function(event) {
                    isConnected = true;
                    statusIndicator.classList.remove('connecting', 'disconnected');
                    statusIndicator.classList.add('connected');
                    statusText.textContent = '已连接';

                };

                // 接收到消息时的处理
                websocket.onmessage = function(event) {
                    try {
                        // 解析消息格式: code=1##data=结果内容
                        const message = event.data;
                        const parts = message.split('##');

                        if (parts.length >= 2) {
                            const codePart = parts[0];
                            const dataPart = parts[1];

                            // 提取code值
                            if (codePart.startsWith('code=')) {
                                const code = parseInt(codePart.substring(5));

                                // 提取data值
                                if (dataPart.startsWith('data=')) {
                                    const data = dataPart.substring(5);

                                    if (code === 1) {
                                        // 成功
                                        addOutput(data, 'response');
                                    } else {
                                        // 失败
                                        addOutput(`${data}`, 'error');
                                    }
                                } else {
                                    addOutput(`无法解析消息: ${message}`, 'error');
                                }
                            } else {
                                addOutput(`无法解析消息: ${message}`, 'error');
                            }
                        } else {
                            // 如果不是标准格式，直接显示
                            addOutput(message);
                        }
                    } catch (error) {
                        addOutput(`${error.message}`, 'error');
                    }
                };

                // 连接关闭时的处理
                websocket.onclose = function(event) {
                    isConnected = false;

                    // 更新 UI 状态
                    statusIndicator.classList.remove('connecting', 'connected');
                    statusIndicator.classList.add('disconnected');
                    statusText.textContent = '未连接';

                    // 判断是否是服务器因认证失败关闭
                    if (event.code === 500) {
                        // 服务器明确告知认证失败，必须重新登录
                        addOutput(`会话已失效: ${event.reason || '身份验证失败'}`, 'error');
                        addOutput('正在跳转到登录页面...', 'error');

                        // 停止任何重连尝试，直接登出
                        setTimeout(() => {
                            logout(); // 会关闭连接、清 token、跳回登录页
                        }, 1000);

                    }
                    else if (event.wasClean) {
                        // 正常关闭（如用户主动 disconnect）
                        addOutput(`连接已关闭: ${event.code} ${event.reason || ''}`, 'info');
                    }
                    else {
                        // 非正常关闭（网络问题等），可尝试重连
                        addOutput('连接异常断开，正在尝试重新连接...', 'error');

                        // 可选：延迟重连
                        setTimeout(() => {
                            if (authToken) {
                                connectWebSocket(); // 会先校验 token
                            }
                            // 否则用户需手动登录
                        }, 2000);
                    }
                };

                // 连接错误时的处理
                websocket.onerror = function(error) {
                    addOutput('connect error!', 'error');
                    console.error('WebSocket错误:', error);
                };
            } catch (error) {
                statusIndicator.classList.remove('connecting');
                statusIndicator.classList.add('disconnected');
                statusText.textContent = '连接失败';

                addOutput(`Cannot connect to websocket server: ${error.message}`, 'error');
            }
        }

        // 通过WebSocket发送命令（只发送纯命令，不包含token）
        function sendCommand(command) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addOutput('Not connected', 'error');
                return false;
            }

            try {
                // 只发送纯命令，token已经在连接时通过URL参数传递
                websocket.send(command);
                return true;
            } catch (error) {
                addOutput(`${error.message}`, 'error');
                return false;
            }
        }

        // 显示登录消息
        function showLoginMessage(message, type = 'response') {
            loginMessage.textContent = message;
            loginMessage.className = `login-message ${type}`;
            loginMessage.style.display = 'block';
        }

        // 启动token过期计时器
        function startTokenTimer(expireTime) {
            // 清除现有的计时器
            if (tokenTimer) {
                clearTimeout(tokenTimer);
            }

            // 设置新的计时器
            tokenTimer = setTimeout(() => {
                addOutput('登录已过期，请重新登录', 'error');
                logout();
            }, expireTime);
        }

        // 更新token过期时间显示
        function updateTokenExpiryDisplay(expiry) {
            // 清除之前的定时器（如果存在）
            if (tokenInterval) {
                clearInterval(tokenInterval);
            }

            const updateDisplay = () => {
                const now = new Date().getTime();
                const remaining = expiry - now;

                if (remaining <= 0) {
                    tokenExpiryElement.textContent = '已过期';
                    return;
                }

                // 转换为分钟和秒
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);

                tokenExpiryElement.textContent = `Token剩余时间: ${minutes}分${seconds}秒`;
            };

            // 立即更新一次
            updateDisplay();

            // 每秒更新一次，并保存引用以便后续清除
            tokenInterval = setInterval(updateDisplay, 1000);
        }

        // 显示终端界面
        function showTerminal() {
            const loginContainer = document.getElementById('loginContainer');
            const terminalOutput = document.getElementById('terminalOutput');

            loginContainer.style.display = 'none';
            terminalOutput.style.display = 'flex';
            commandInput.focus();

            // 添加欢迎消息
            addOutput(`欢迎您 ${currentUser}！`, 'success');
            addOutput('输入 "help" 查看可用命令列表。');
        }

        // 退出登录
        function logout() {
            // 关闭WebSocket连接
            if (websocket) {
                websocket.close();
                websocket = null;
            }

            // 清除token和计时器
            authToken = null;
            localStorage.removeItem('argus-token');
            localStorage.removeItem('argus-token-expiry');

            if (tokenTimer) {
                clearTimeout(tokenTimer);
                tokenTimer = null;
            }

            // 清除token显示定时器
            if (tokenInterval) {
                clearInterval(tokenInterval);
                tokenInterval = null;
            }

            // 隐藏终端界面，显示登录界面
            const loginContainer = document.getElementById('loginContainer');
            const terminalOutput = document.getElementById('terminalOutput');
            const tokenInfo = document.getElementById('tokenInfo');

            loginContainer.style.display = 'flex';
            terminalOutput.style.display = 'none';
            tokenInfo.style.display = 'none';

            // 清空密码字段
            document.getElementById('password').value = '';
        }

        // 命令输入事件
        commandInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const command = commandInput.value.trim();
                if (command) {
                    // 保存命令到历史
                    commands.push(command);
                    commandIndex = commands.length;

                    // 添加命令到历史
                    addOutput(`argus@${currentUser}~$ ${command}`, 'command');

                    // 处理命令
                    handleCommand(command);

                    // 清空输入
                    commandInput.value = '';

                    // 重新添加命令输入行
                    addCommandInputLine();
                }
            } else if (e.key === 'ArrowUp') {
                // 上箭头键 - 显示上一条命令
                e.preventDefault();
                if (commands.length > 0) {
                    if (commandIndex > 0) commandIndex--;
                    commandInput.value = commands[commandIndex] || '';
                }
            } else if (e.key === 'ArrowDown') {
                // 下箭头键 - 显示下一条命令
                e.preventDefault();
                if (commandIndex < commands.length - 1) {
                    commandIndex++;
                    commandInput.value = commands[commandIndex] || '';
                } else {
                    commandIndex = commands.length;
                    commandInput.value = '';
                }
            } else if (e.key === 'Tab') {
                // Tab键 - 自动补全
                e.preventDefault();
                const input = commandInput.value;
                const availableCommands = ['help', 'date', 'clear', 'connect', 'disconnect', 'logout', 'exit', 'ls', 'pwd', 'whoami', 'echo'];
                const matches = availableCommands.filter(cmd => cmd.startsWith(input));

                if (matches.length === 1) {
                    commandInput.value = matches[0];
                } else if (matches.length > 1) {
                    addOutput('可能的命令: ' + matches.join(', '));
                }
            }
        });

        // 添加输出到终端
        function addOutput(text, type = 'response') {
            const outputDiv = document.createElement('div');
            outputDiv.className = `output ${type}`;
            outputDiv.textContent = text;
            commandHistory.appendChild(outputDiv);

            // 自动滚动到底部
            scrollToBottom();
        }

        // 添加命令输入行
        function addCommandInputLine() {
            // 创建新的命令输入行
            const commandLine = document.createElement('div');
            commandLine.className = 'command-line';

            const prompt = document.createElement('span');
            prompt.className = 'prompt';
            prompt.textContent = `argus@${currentUser}:~$`;
            prompt.id = 'userPrompt';

            const inputLine = document.createElement('div');
            inputLine.className = 'input-line';

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'command-input';
            input.id = 'commandInput';
            input.autocomplete = 'off';
            input.autofocus = true;

            inputLine.appendChild(input);

            commandLine.appendChild(prompt);
            commandLine.appendChild(inputLine);

            // 添加到输出容器
            const outputContainer = document.getElementById('outputContainer');
            outputContainer.appendChild(commandLine);

            // 移除旧的输入行
            const oldInput = document.getElementById('commandInput');
            if (oldInput && oldInput.parentNode && oldInput.parentNode.parentNode) {
                oldInput.parentNode.parentNode.remove();
            }

            // 设置焦点到新输入框
            input.focus();

            // 更新全局引用
            window.commandInput = input;

            // 添加事件监听器
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const command = input.value.trim();
                    if (command) {
                        // 保存命令到历史
                        commands.push(command);
                        commandIndex = commands.length;

                        // 添加命令到历史
                        addOutput(`argus@${currentUser}~$ ${command}`, 'command');

                        // 处理命令
                        handleCommand(command);

                        // 清空输入
                        input.value = '';

                        // 重新添加命令输入行
                        addCommandInputLine();
                    }
                } else if (e.key === 'ArrowUp') {
                    // 上箭头键 - 显示上一条命令
                    e.preventDefault();
                    if (commands.length > 0) {
                        if (commandIndex > 0) commandIndex--;
                        input.value = commands[commandIndex] || '';
                    }
                } else if (e.key === 'ArrowDown') {
                    // 下箭头键 - 显示下一条命令
                    e.preventDefault();
                    if (commandIndex < commands.length - 1) {
                        commandIndex++;
                        input.value = commands[commandIndex] || '';
                    } else {
                        commandIndex = commands.length;
                        input.value = '';
                    }
                } else if (e.key === 'Tab') {
                    // Tab键 - 自动补全
                    e.preventDefault();
                    const inputVal = input.value;
                    const availableCommands = ['help', 'date', 'clear', 'connect', 'disconnect', 'logout', 'exit', 'ls', 'pwd', 'whoami', 'echo'];
                    const matches = availableCommands.filter(cmd => cmd.startsWith(inputVal));

                    if (matches.length === 1) {
                        input.value = matches[0];
                    } else if (matches.length > 1) {
                        addOutput('可能的命令: ' + matches.join(', '));
                    }
                }
            });

            // 自动滚动到底部
            scrollToBottom();
        }

        // 处理命令
        function handleCommand(command) {
            // 特殊命令处理
            switch(command.toLowerCase()) {
                case 'clear':
                    commandHistory.innerHTML = '';
                    // 重新添加命令输入行
                    addCommandInputLine();
                    break;
                case 'connect':
                    if (isConnected) {
                        addOutput('Already connected.', 'error');
                    } else {
                        connectWebSocket();
                    }
                    break;
                case 'disconnect':
                    if (!isConnected || !websocket) {
                        addOutput('', 'error');
                    } else {
                        websocket.close();
                        addOutput('WebSocket连接已关闭。');
                    }
                    break;
                case 'logout':
                    setTimeout(logout, 1000);
                    break;
                case 'exit':
                    if (confirm('确定要关闭终端吗？')) {
                        setTimeout(() => {
                            window.close();
                        }, 1000);
                    }
                    break;
                default:
                    // 其他命令通过WebSocket发送（只发送纯命令）
                    sendCommand(command)
            }
        }
    });

    // 终端控制函数
    function minimizeTerminal() {
        document.body.style.display = 'none';
        setTimeout(() => {
            alert('终端已最小化。点击确定恢复。');
            document.body.style.display = 'flex';
        }, 300);
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`全屏模式错误: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }

    function closeTerminal() {
        if (confirm('确定要关闭终端吗？')) {
            window.close();
        }
    }
</script>
</body>
</html>